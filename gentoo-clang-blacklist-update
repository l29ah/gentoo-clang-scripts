#!/bin/sh
set -x
repo_uri="https://github.com/l29ah/gentoo-clang-db"
repo_path=/etc/portage/gentoo-clang/

portage_env_file=/etc/portage/package.env/80-clang-blacklist
portage_env_name=use-default-compiler

update_git() {
	if [ ! -d "$repo_path" ]; then
		git clone -q "$repo_uri" "$repo_path" > /dev/null 2>&1 || {
			echo "Clone failed"
			exit 1
		}
	else
		pushd "$repo_path" > /dev/null
		git pull -q > /dev/null 2>&1 || {
			echo "Pull failed"
			exit 1
		}
		popd > /dev/null
	fi
}

cd "$repo_path"
case "$PACKAGE_MANAGER" in
	portage|'')		# assume portage is used when PACKAGE_MANAGER is unset
		update_git

		[ -f "$portage_env_file" ] || touch "$portage_env_file" || {
			echo "Can't access $portage_env_file, ensure $(dirname "$portage_env_file") is a directory"
			exit 2
		}
		{
			echo "# Autogenerated by `readlink -fe "$0"`, don't edit"
			sed "s/#.*//; s/\\s*//g; /^$/d; s/$/ $portage_env_name/" "${repo_path}/blacklist"
		} > "$portage_env_file"
		;;
	paludis)
		update_git;;
	*)
		echo not implemented;;
esac
